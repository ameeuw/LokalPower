{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

<div class="wrapper">
	<div class="main-panel" style="">
		<div class="content">
		{% block body %}

			<div class="container-fluid">
				<div class="row embed-responsive embed-responsive-16by9" style="">

					<div class="col-md-8 embed-responsive-item" style="width: 65%;">
						<div class="well" id="overview_chart" style="height: 75%"></div>
					</div>

					<div class="col-md-4 embed-responsive-item" style="left: 65%; max-width: 35%; max-height: 75%">
						<div class="row" style="height: 100%;">
							<div class="col-md-12" style="height: 100%">
								<div class="well" style="height: 100%">
									<div id="pie_chart_connections" style="height: 100%"></div>
								</div>
							</div>
						</div>

						<div class="row" style="height: 100%;">
							<div class="col-md-12" style="height: 100%; top: 8%">
								<div class="well" style="height: 100%;">
									<div id="pie_chart_deliveries" style="height: 100%"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		{% endblock %}
		</div>
	</div>

{% block footer %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<!--<script type="text/javascript" src="{{ url_for('static', filename='charts/overview_chart.js') }}"></script>-->

<script type="text/javascript">

Highcharts.chart('pie_chart_connections', {
	chart: {
		backgroundColor: 'var(--chart-bg-color)',
		plotBackgroundColor: null,
		plotBorderWidth: null,
		plotShadow: false,
		type: 'pie'
	},
	title: {
		text: 'Verbrauch ({{ user.period['sum_consumption'] | round(1) }} kWh)',
		align: 'left'
	},
	tooltip: {
		formatter: function() {
			return '<b><span style="font-size: 130%">' + this.point.name + '</b></span><br>Anteil: ' + this.y.toFixed(1) + ' kWh (' + this.percentage.toFixed(1) + ' %)';
		},
	},
	plotOptions: {
		pie: {
			allowPointSelect: true,
			cursor: 'pointer',
			align: 'left',
			dataLabels: {
				enabled: false,
				name: 'Anteile',
				format: '<b>{point.name}</b>: {point.percentage:.1f} %',
				style: {
					color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
				}
			},
		showInLegend: true,
		}
	},
	series: [{
		name: 'Anteil',
		colorByPoint: true,
		size: '100%',
		innerSize: '60%',
		data: [

				{% for category, category_dict in user.period['categorized_connections'].iteritems() %}
				{
					name: '{{ category | replace("self","Selbstversorgung") | replace("local","Bezug Lokal (<10km)") | replace("grisons","Bezug Graubünden") | replace("other","Bezug Schweiz") }}',
					y: {{ category_dict['sum'] }},
					color: '{{ category | replace("self","var(--self-color)") | replace("local","var(--local-color)") | replace("grisons","var(--grisons-color)") | replace("other","var(--other-color)") }}',
					legendIndex: {{ category | replace("self","0") | replace("local","1") | replace("grisons","2") | replace("other","3") }},
				},
				{% endfor %}
		]
	}],
	legend: {
		layout: 'vertical',
		align: 'right',
		verticalAlign: 'middle',
		itemMarginTop: 8,
		labelFormatter: function() {
			return this.name + " (" + this.percentage.toFixed(1) + " %)";
		}
	}
});

Highcharts.chart('pie_chart_deliveries', {
	chart: {
		backgroundColor: 'var(--chart-bg-color)',
		plotBackgroundColor: null,
		plotBorderWidth: null,
		plotShadow: false,
		type: 'pie'
	},
	title: {
		text: 'Produktion ({{ user.period['sum_production'] | round(1) }} kWh)',
		align: 'left'
	},
	tooltip: {
		formatter: function() {
			return '<b><span style="font-size: 130%">' + this.point.name + '</b></span><br>Anteil: ' + this.y.toFixed(1) + ' kWh (' + this.percentage.toFixed(1) + ' %)';
		},
	},
	plotOptions: {
		pie: {
			allowPointSelect: true,
			cursor: 'pointer',
			align: 'left',
			dataLabels: {
				enabled: false,
				name: 'Anteile',
				format: '<b>{point.name}</b>: {point.percentage:.1f} %',
				style: {
					color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
				}
			},

		showInLegend: true,

		},

	},
	series: [{
		name: 'Anteil',
		colorByPoint: true,
		size: '100%',
		innerSize: '60%',
		data: [

				{% for category, category_dict in user.period['categorized_deliveries'].iteritems() %}
				{
					name: '{{ category | replace("self","Eigenverbrauch") | replace("local","Einspeisung Lokal (<10km)") | replace("grisons","Einspeisung Graubünden") | replace("other","Einspeisung Netz") }}',
					y: {{ category_dict['sum'] }},
					color: '{{ category | replace("self","var(--self-color)") | replace("local","var(--local-color)") | replace("grisons","var(--grisons-color)") | replace("other","var(--other-color)") }}',
					legendIndex: {{ category | replace("self","0") | replace("local","1") | replace("grisons","2") | replace("other","3") }},
				},
				{% endfor %}
		]
	}],
	legend: {
		layout: 'vertical',
		align: 'right',
		verticalAlign: 'middle',
		itemMarginTop: 8,
		labelFormatter: function() {
			return this.name + " (" + this.percentage.toFixed(1) + " %)";
		}
	}
});



{% if user.period['resolution'] == 'minimal' %}
	Highcharts.Series.prototype.drawPoints = function() { };
{% endif %}
var overview_chart = Highcharts.chart('overview_chart', {
	chart: {
		backgroundColor: 'var(--chart-bg-color)'
	},

	title: {
		{% if user.annual_production > 0 %}
			text: 'Verbrauch und Produktion'
		{% else %}
			text: 'Verbrauch'
		{% endif %}
	},

	subtitle: {
		text: ''
	},

	{% if user.period['resolution'] == 'monthly' %}
	plotOptions: {
		series: {
			cursor: 'pointer',
			point: {
				events: {
					click: function() {
						location.href='/setDailyPeriod/' + this.index + '/' + '{{ origin }}' + '/' + 'all';
					}
				}
			}
		}
	},
	{% endif %}

	{% if user.period['resolution'] == 'daily' %}
	plotOptions: {
		series: {
			cursor: 'pointer',
			point: {
				events: {
					click: function() {
						// add up start of period and clicked day in month
						day = {{ user.period['start'] }} + this.index;
						location.href='/setMinimalPeriod/' + day + '/' + '{{ origin }}' + '/' + 'all';
					}
				}
			}
		}
	},
	{% endif %}

	yAxis: {
		title: {
			text: 'kWh'
		}
	},

	xAxis: {
		categories: {{ user.period['categories']|safe }},
		{% if user.period['resolution'] == 'minimal' %}
		labels: {
			step: 4,
			rotation: 45
		},
		{% endif %}
		crosshair: true
	},

	tooltip: {
		headerFormat: '<span style="font-size:14px">{{ user.period['resolution'] | replace("daily", "Tag") | replace("monthly", "Monat") | replace("minimal", "Uhrzeit") }}: {point.key}</span><br><table>',
		pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
			'<td style="padding-right:5px;"><b> {point.y:.1f}</b></td><td style="padding-left:3px">kWh</td></tr>',
		footerFormat: '</table>',
		shared: true,
		useHTML: true,
		borderColor: '#000000'
	},

	series: [

	{
		type: 'spline',
		stacking: false,
		name: 'Verbrauch',
		colorByPoint: false,
		color: 'var(--consumption-color)',
		data: {{ user.period['demand'] | safe }},
		showInLegend: true,
		legendIndex: 0,
		index: 3
	},

	{% if user.period['sum_production'] > 0 %}
	{
		type: 'spline',
		name: 'Produktion',
		colorByPoint: false,
		color: 'var(--production-color)',
		data: {{ user.period['production'] | safe }},
		showInLegend: true,
		legendIndex: 1,
		index: 2
	},

	{
		type: 'areaspline',
		fillOpacity: 0.5,
		stacking: true,
		name: 'Batterie S (4 kWh)',
		colorByPoint: false,
		color: 'var(--battery-color)',
		fillColor: 'var(--battery-fill-color)',
		data: {{ user.period['battery_simulation']['battery_to_load'] | safe }},
		showInLegend: true,
		visible: false,
		legendIndex: 3,
		index: 0
	},

	{
		type: 'areaspline',
		stacking: true,
		name: 'Eigenverbrauch',
		colorByPoint: false,
		color: 'var(--self-consumption-color)',
		fillColor: 'var(--self-consumption-fill-color)',
		data: {{ user.period['self_consumption'] | safe }},
		showInLegend: true,
		legendIndex: 2,
		index: 1
	},
	{% endif %}

	]


	});

var legend = overview_chart.legend;
for (var i = 0, len = legend.allItems.length; i < len; i++) {
   (function(i) {
       var t=legend.allItems[i],
           content= '<b>'+ t.name +'</b>: '+ Math.round(t.percentage*100)/100 + ' %';
           jQuery($(t.legendItem.element)).tooltip({title:content,html:true});
   })(i);
}

</script>
{% endblock %}