{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

<div class="wrapper">
	{% block sidebar %}

		<div class="sidebar" data-color="purple" data-image="../assets/img/sidebar-1.jpg">

			<div class="logo">
				<a href="" class="simple-text">
					Lokal Power
				</a>
			</div>

				<div class="sidebar-wrapper">
					<ul class="nav">
						<li>
							<a href="{{ url_for('home') }}">
								<i class="material-icons">dashboard</i>
								<p>Ãœbersicht</p>
							</a>
						</li>

						<li>
							<a href="{{ url_for('osmaps', type='sources') }}">
								<i class="material-icons">location_on</i>
								<p>Verbrauch: Karte</p>
							</a>
						</li>
						<li >
							<a href="{{ url_for('details', type='sources') }}">
								<i class="fa fa-share-alt" aria-hidden="true"></i>
								<p>Verbrauch: Details</p>
							</a>
						</li>

						<li>
							<a href="{{ url_for('osmaps', type='sinks') }}">
								<i class="material-icons">location_off</i>
								<p>Produktion: Karte</p>
							</a>
						</li>
						<li >
							<a href="{{ url_for('details', type='sinks') }}">
								<i class="fa fa-share-alt" aria-hidden="true"></i>
								<p>Produktion: Details</p>
							</a>
						</li>

						<li class="active">
							<a href="{{ url_for('battery') }}">
								<i class="fa fa-battery-half" aria-hidden="true"></i>
								<p>PV-Batteriesimulator</p>
							</a>
						</li>
					</ul>
				</div>
			</div>

	{% endblock %}

	<div class="main-panel">
		<div class="content">
		{% block body %}

			<div class="container-fluid">
				<div class="row embed-responsive embed-responsive-16by9" style="">

					<div class="col-md-8 embed-responsive-item" style="width: 65%;">
						<div class="well" id="overview_chart" style="height: 75%"></div>
					</div>

					<div class="col-md-4 embed-responsive-item" style="left: 65%; max-width: 35%; max-height: 74.5%">
						<div class="row" style="height: 100%;">
							<div class="col-md-12" style="height: 100%">
								<div class="well" style="height: 100%">
									<div id="pie_chart" style="height: 100%"></div>
								</div>
							</div>
						</div>

						<div class="row" style="height: 100%;">
							<div class="col-md-12" style="height: 100%; top: 8%">
								<div class="well" style="height: 100%;">
									<form role="form" method="post" action="{{ url_for('battery') }}">
										<button name="BatteryCapacity" value="4">Batterie S (4 kWh)</button><br><br>
										<button name="BatteryCapacity" value="8">Batterie M (8 kWh): ca. 10'000,- CHF</button><br><br>
										<button name="BatteryCapacity" value="12">Batterie L (12 kWh)</button><br><br>
										<button name="BatteryCapacity" value="16">Batterie XL (16 kWh)</button><br><br>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endblock %}
	</div>
</div>

	</div>
</div>



{% block footer %}

<!--
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
-->

<script type="text/javascript">

var grid_to_load = {{ user.battery_simulation['annual_G2L'] |safe }};
var solar_to_load = {{ user.battery_simulation['annual_PV2L'] |safe }};
var battery_to_load = {{ user.battery_simulation['annual_B2L'] |safe }};

var monthly_pv2l = {{ user.battery_simulation['monthly_pv2l'] |safe }};
var monthly_pv = {{ user.battery_simulation['monthly_pv'] |safe }};
var monthly_b2l = {{ user.battery_simulation['monthly_b2l'] |safe }};
var monthly_demand = {{ user.demand_by_month |safe }};


Highcharts.chart('pie_chart', {
    chart: {
    	backgroundColor: 'var(--chart-bg-color)',
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        type: 'pie'
    },
    title: {
        text: 'Deckungsgrad Ihres Verbrauchs'
    },

	subtitle: {
		text: '100 % = {{ user.period['sum_consumption'] }} kWh'
	},
    tooltip: {
        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
    },
    plotOptions: {
        pie: {
            allowPointSelect: true,
            cursor: 'pointer',
            dataLabels: {
                enabled: false,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                style: {
                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                }
            },
        showInLegend: true,
        }
    },

	series: [{
		name: 'Anteil',
		colorByPoint: true,
		size: '100%',
		innerSize: '60%',
		data: [
			{
				name: 'Solar (direkt)',
				color: 'var(--local-color)',
				y: solar_to_load,
				showInLegend: true,
				legendIndex: 0
			},
			{
				name: 'Batterie',
				color: 'var(--battery-color)',
				y: battery_to_load,
				sliced: true,
				showInLegend: true,
				legendIndex: 1
			},
			{
				name: 'Netz',
				color: 'var(--other-color)',
				y: grid_to_load,
				showInLegend: true,
				legendIndex: 2
			}
		]
	}],
	legend: {
		layout: 'vertical',
		align: 'right',
		verticalAlign: 'bottom',
		labelFormatter: function() {
			return this.name + " (" + this.percentage.toFixed(1) + " %)";
		}
	}
});


Highcharts.chart('overview_chart', {
	chart: {
		backgroundColor: 'var(--chart-bg-color)'
	},

	title: {
		text: 'Simulation'
	},

	subtitle: {
		text: ''
	},

	yAxis: {
		title: {
			text: 'kWh'
		}
	},

	xAxis: {
		crosshair: true
	},

	tooltip: {
		headerFormat: '<span style="font-size:14px">{{ user.period['resolution'] | replace("daily", "Tag") | replace("monthly", "Monat") | replace("minimal", "Uhrzeit") }}: {point.key}</span><br><table>',
		pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
			'<td style="padding:5"><b>{point.y:.1f}</b></td><td style="padding-left:3px">kWh</td></tr>',
		footerFormat: '</table>',
		shared: true,
		useHTML: true
	},

	series: [

	{
		type: 'spline',
		stacking: false,
		name: 'Produktion',
		colorByPoint: false,
		color: 'var(--production-color)',
		data: monthly_pv,
		showInLegend: true,
		legendIndex: 1
	},

	{
		type: 'spline',
		stacking: false,
		name: 'Verbrauch',
		colorByPoint: false,
		color: 'var(--consumption-color)',
		data: monthly_demand,
		showInLegend: true,
		legendIndex: 0
	},

	{
		type: 'areaspline',
		stacking: true,
		name: 'Batterie',
		colorByPoint: false,
		color: 'var(--battery-color)',
		fillColor: 'var(--battery-fill-color)',
		data: monthly_b2l,
		showInLegend: true,
		legendIndex: 3
	},

	{
		type: 'areaspline',
		fillOpacity: 0.5,
		stacking: true,
		name: 'Eigenverbrauch',
		colorByPoint: false,
		color: 'var(--self-consumption-color)',
		fillColor: 'var(--self-consumption-fill-color)',
		data: monthly_pv2l,
		showInLegend: true,
		legendIndex: 2
	}

	]
});

</script>
{% endblock %}


